<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargar Pacientes - SIMORAHealth</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        button {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 0;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button.danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        button.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            display: none;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        .icon {
            font-size: 20px;
        }
        .progress {
            margin-top: 15px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        .step-number {
            display: inline-block;
            width: 28px;
            height: 28px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• SIMORAHealth</h1>
        <p class="subtitle">Importador de Pacientes</p>

        <div class="step">
            <span class="step-number">1</span>
            <strong>Limpiar datos ficticios</strong>
            <button onclick="clearMockPatients()" class="danger" id="clearBtn">
                <span class="icon">üóëÔ∏è</span>
                Eliminar pacientes ficticios
            </button>
        </div>

        <div class="step">
            <span class="step-number">2</span>
            <strong>Cargar pacientes reales</strong>
            <button onclick="importPatients()" id="importBtn" disabled>
                <span class="icon">üì•</span>
                Importar 238 pacientes
            </button>
        </div>

        <div class="step">
            <span class="step-number">3</span>
            <strong>Verificar estado</strong>
            <button onclick="checkStatus()" class="info" id="statusBtn">
                <span class="icon">üìä</span>
                Ver estado actual
            </button>
        </div>

        <div class="progress" id="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div id="result" class="result"></div>
    </div>

    <script>
        let step = 0;

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }

        function updateProgress(percent) {
            const progress = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            progress.style.display = 'block';
            progressBar.style.width = percent + '%';
        }

        function clearMockPatients() {
            try {
                const btn = document.getElementById('clearBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="icon">‚è≥</span> Eliminando...';

                localStorage.removeItem('patients');

                setTimeout(() => {
                    btn.innerHTML = '<span class="icon">‚úÖ</span> Pacientes eliminados';
                    showResult('‚úì Pacientes ficticios eliminados correctamente', 'success');
                    document.getElementById('importBtn').disabled = false;
                    step = 1;
                }, 500);

            } catch (error) {
                showResult('‚ùå Error al eliminar pacientes: ' + error.message, 'error');
                document.getElementById('clearBtn').disabled = false;
            }
        }

        async function importPatients() {
            const btn = document.getElementById('importBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="icon">‚è≥</span> Cargando...';

            try {
                updateProgress(10);
                showResult('üìÇ Cargando archivo JSON...', 'info');

                const response = await fetch('../data-migration/pacientes_completos.json');
                if (!response.ok) {
                    throw new Error('No se pudo cargar el archivo. Aseg√∫rate de que el servidor de desarrollo est√© corriendo.');
                }

                updateProgress(30);
                const importedPatients = await response.json();

                if (!Array.isArray(importedPatients)) {
                    throw new Error('El archivo JSON debe contener un array de pacientes');
                }

                updateProgress(50);
                showResult(`üîÑ Transformando ${importedPatients.length} pacientes...`, 'info');

                const patients = importedPatients.map(p => ({
                    firestoreId: p.id,
                    ficha: parseInt(p.numeroFicha) || Math.floor(Math.random() * 100000),
                    nombre: p.nombre,
                    rut: '',
                    edad: 0,
                    sexo: 'Masculino',
                    identidadGenero: '',
                    fechaNacimiento: '2000-01-01',
                    direccion: '',
                    comuna: '',
                    lat: -35.4264,
                    lon: -71.6554,
                    telefonos: [],
                    email: '',
                    tutor: 'No aplica',
                    ocupacion: '',
                    dispositivoAPS: '',
                    alergias: '',
                    ram: '',
                    objetivosTerapeuticos: '',
                    diagnostico: {
                        saludMental: '',
                        morbilidadMedica: '',
                        factoresPsicosociales: ''
                    },
                    farmacos: [],
                    pensionDiscapacidad: false,
                    credencialDiscapacidad: false,
                    consumoActivoDrogas: false,
                    contenidoOriginal: p.contenidoCompleto,
                    tags: p.tags || [],
                    fechaCreacion: p.fechaCreacion,
                    fechaActualizacion: p.fechaActualizacion,
                    origen: p.origen
                }));

                updateProgress(80);
                localStorage.setItem('patients', JSON.stringify(patients));

                updateProgress(100);
                btn.innerHTML = '<span class="icon">‚úÖ</span> Importaci√≥n completada';
                showResult(
                    `üéâ <strong>¬°Importaci√≥n exitosa!</strong><br><br>` +
                    `Se importaron <strong>${patients.length} pacientes</strong> correctamente.<br><br>` +
                    `<small>Ahora puedes cerrar esta ventana y recargar la aplicaci√≥n principal.</small>`,
                    'success'
                );
                step = 2;

                // Auto-redirect despu√©s de 3 segundos
                setTimeout(() => {
                    showResult(
                        `‚úÖ <strong>Importaci√≥n completada</strong><br><br>` +
                        `Redirigiendo a la aplicaci√≥n principal...`,
                        'success'
                    );
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                }, 3000);

            } catch (error) {
                updateProgress(0);
                btn.disabled = false;
                btn.innerHTML = '<span class="icon">üì•</span> Reintentar importaci√≥n';
                showResult(
                    `‚ùå <strong>Error en la importaci√≥n:</strong><br><br>${error.message}<br><br>` +
                    `<small>Aseg√∫rate de que el servidor de desarrollo est√© corriendo en http://localhost:3000</small>`,
                    'error'
                );
                console.error('Error completo:', error);
            }
        }

        function checkStatus() {
            try {
                const patientsJson = localStorage.getItem('patients');
                if (!patientsJson) {
                    showResult(
                        '‚ö†Ô∏è <strong>No hay pacientes en el sistema</strong><br><br>' +
                        'Por favor, sigue los pasos 1 y 2 para importar los pacientes.',
                        'warning'
                    );
                    return;
                }

                const patients = JSON.parse(patientsJson);
                showResult(
                    `üìä <strong>Estado del sistema:</strong><br><br>` +
                    `Total de pacientes: <strong>${patients.length}</strong><br>` +
                    `Almacenamiento: localStorage<br>` +
                    `Tama√±o de datos: ~${(JSON.stringify(patients).length / 1024).toFixed(2)} KB`,
                    'info'
                );

            } catch (error) {
                showResult('‚ùå Error al verificar estado: ' + error.message, 'error');
            }
        }

        // Verificar estado al cargar
        window.addEventListener('load', () => {
            checkStatus();
        });
    </script>
</body>
</html>
